/*!
  superbly tagfield v0.6
  http://www.superbly.ch
 
  Copyright 2011, Manuel Spierenburg
  Dual licensed under the MIT or GPL Version 2 licenses.
  http://www.superbly.ch/licenses/mit-license.txt
  http://www.superbly.ch/licenses/gpl-2.0.txt
 
  Date: 27-11-2011
 */
 (function(a){function c(c,d){function y(){c.val(o.join(","))}function z(){var b=a("<span />").text(u.val()).appendTo(w);var c=b.width();b.remove();u.width(c+20)}function A(a){if(j!=false){if(o.length>=j){return}}if(r!=null){if(m(r)===false){return}B(r)}else if(h){var a=u.val();if(a!=null&&a!=""){if(m(a)===false){return}B(a)}}}function B(a){C(a,true)}function C(b,c){var d=false;if(!g){a.each(o,function(a,c){if(d==false&&c.toLowerCase()==b.toLowerCase()){d=true;return true}})}var e=jQuery.inArray(b,n);if(jQuery.inArray(b,o)==-1&&(e>-1||h)&&!d){if(e>-1){n.splice(e,1)}o.push(b);w.before("<li class='superblyTagItem'><span>"+b+"</span><a> x</a></li>");u.val("");q=null;r=null;var f=x.children(".superblyTagItem").size()-1;a(x.children(".superblyTagItem")[f]).children("a").click(function(b){var c=a(a(this).parent(".superblyTagItem").children("span")[0]).text();F(c)})}v.css("display","none");z();if(c){u.focus()}y();if(j!=false&&o.length>=j){D()}}function D(){u.attr("disabled","disabled");v.css("display","none")}function E(){u.removeAttr("disabled");v.show()}function F(b){var c=jQuery.inArray(b,e);var d=jQuery.inArray(b,n);if(c>-1&&d==-1){n.push(b)}c=jQuery.inArray(b,o);if(c>-1){o.splice(c,1);x.children(".superblyTagItem").filter(function(){return a("span",this).html()==b}).remove()}n.sort();u.focus();y();if(j!=false&&o.length<j){E()}}function G(){var a=o.length-1;var b=o[a];F(b)}function H(a){var b=new Array;var c=0;for(key in n){if(k<=c){break}var d=n[key].toLocaleLowerCase();var e=a.toLowerCase();if(d.indexOf(e)==0){b.push(n[key]);c++}}return b}function I(b){v.show();if(b==q){return false}q=b;v.empty();var c=H(b);for(key in c){v.append("<li class='superblySuggestItem'>"+c[key]+"</li>")}var d=v.children(".superblySuggestItem");d.click(function(b){B(a(this).html())});p=null;if(!h){p=0;a(d[p]).addClass("selected");r=a(d[p]).html()}}function J(){var b=v.children(".superblySuggestItem");var c=b.size();if(p==null){p=0}else if(p<c-1){a(b[p]).removeClass("selected");p++}a(b[p]).addClass("selected");r=a(b[p]).html()}function K(){if(p==0){p=null;r=null;u.focus()}else if(p>0){var b=v.children(".superblySuggestItem");a(b[p]).removeClass("selected");p--;a(b[p]).addClass("selected");r=a(b[p]).html()}}var e=d.tags.sort();var f=d.preset;var g=d.caseSensitive;var h=d.allowNewTags;var j=d.allowedTagsNumber;var k=d.showTagsNumber;var l=d.addItemOnBlur;var m=d.tagValidator;var n=e.slice();var o=new Array;var p=null;var q=null;var r=null;var s=false;c.css("display","none");var t='<div class="superblyTagfieldDiv"><ul class="superblyTagItems"><li class="superblyTagInputItem"><input class="superblyTagInput" type="text" autocomplete="false"><ul class="superblySuggestItems"></ul></li></ul><div class="superblyTagfieldClearer"></div></div>';c.after(t);var u=a(".superblyTagInput",c.next());var v=u.next();var w=u.parent();var x=w.parent();for(i in f){C(f[i],false)}v.mouseover(function(a){s=true});v.mouseleave(function(a){s=false});u.keyup(function(b){if(j==false||o.length<j){I(a(this).val())}});u.focusout(function(a){if(!s){v.css("display","none")}});u.focus(function(a){q=null});u.keydown(function(a){if(a.keyCode==b.downArrow){J()}else if(a.keyCode==b.upArrow){K()}else if(a.keyCode==b.enter||a.keyCode==b.tab){A();return a.keyCode!=b.enter}else if(a.keyCode==b.backspace){if(u.val()==""){G()}z()}else{z()}});if(l){u.blur(function(a){A()})}x.parent().click(function(a){u.focus()})}a.fn.superblyTagField=function(b){var d={caseSensitive:true,allowNewTags:true,allowedTagsNumber:false,showTagsNumber:10,addItemOnBlur:false,preset:[],tags:[],tagValidator:function(a){return true}};if(b){a.extend(d,b)}c(this,d);return this};var b={downArrow:40,upArrow:38,enter:13,tab:9,backspace:8}})(jQuery)